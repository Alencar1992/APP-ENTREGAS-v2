let valorFinal = 0;

const valorKm = 1.90;
const taxaMinima = 5.00;

let clientes = JSON.parse(localStorage.getItem("clientes")) || {};
let historico = JSON.parse(localStorage.getItem("historico")) || [];

function carregarClientes() {
  const select = document.getElementById("cliente");
  select.innerHTML = `<option value="">Selecione a cliente</option>`;

  for (let nome in clientes) {
    select.innerHTML += `<option value="${nome}">${nome}</option>`;
  }
}

carregarClientes();

function calcular() {
  const km = parseFloat(document.getElementById("km").value);
  let valor = 0;
  document.getElementById("aviso").innerText = "";

  if (km <= 15) {
    valor = km * valorKm;
  } else {
    valor = (15 * valorKm) + ((km - 15) * (0.5 * valorKm));
  }

  if (valor < taxaMinima) {
    valor = taxaMinima;
    document.getElementById("aviso").innerText = "âš ï¸ Taxa MÃ­nima Aplicadaâœ…";
  }

  valorFinal = valor.toFixed(2);
  document.getElementById("resultado").innerText =
    `ðŸ’° Valor do frete: R$ ${valorFinal}`;
}

function adicionarCliente() {
  const nome = document.getElementById("nomeCliente").value;
  let numero = document.getElementById("numeroCliente").value.replace(/\D/g, "");

  if (!nome || !numero) {
    alert("Preencha nome e nÃºmero.");
    return;
  }

  clientes[nome] = "55" + numero;
  localStorage.setItem("clientes", JSON.stringify(clientes));
  carregarClientes();

  alert("Cliente salvo!");
}

function whatsapp() {
  const cliente = document.getElementById("cliente").value;
  const km = document.getElementById("km").value;

  if (!cliente || valorFinal === 0) {
    alert("Calcule o frete e selecione a cliente.");
    return;
  }

  const data = new Date().toLocaleString("pt-BR");
  const numero = clientes[cliente];

  const mensagem =
`ðŸï¸ðŸ’¨ *ALENCAR FRETES*ðŸ“¦
ðŸ‘¤ Cliente: ${cliente}
ðŸ“ KM: ${km}
ðŸ’° Valor: R$ ${valorFinal}
ðŸ“… ${data}`;

  navigator.clipboard.writeText(mensagem);

  historico.push(mensagem);
  localStorage.setItem("historico", JSON.stringify(historico));

  atualizarHistorico();

  const url = `https://wa.me/${numero}?text=${encodeURIComponent(mensagem)}`;
  window.open(url, "_blank");
}

function atualizarHistorico() {
  const div = document.getElementById("historico");
  div.innerHTML = "";

  historico.slice().reverse().forEach(item => {
    div.innerHTML += `<p>${item.replace(/\n/g, "<br>")}<hr></p>`;
  });
}

atualizarHistorico();
