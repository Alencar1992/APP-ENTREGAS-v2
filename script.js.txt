const VALOR_KM = 1.90;
const TAXA_MINIMA = 5.00;

let valorFinal = 0;

let clientes = JSON.parse(localStorage.getItem("clientes")) || {};
let historico = JSON.parse(localStorage.getItem("historico")) || [];

// carregar clientes
function carregarClientes() {
  const select = document.getElementById("cliente");
  select.innerHTML = `<option value="">Selecione a cliente</option>`;

  for (const nome in clientes) {
    select.innerHTML += `<option value="${nome}">${nome}</option>`;
  }
}

carregarClientes();
atualizarHistorico();

// calcular frete
function calcular() {
  const km = parseFloat(document.getElementById("km").value);
  document.getElementById("aviso").innerText = "";

  if (!km || km <= 0) {
    alert("Informe uma distÃ¢ncia vÃ¡lida.");
    return;
  }

  let valor;

  if (km <= 15) {
    valor = km * VALOR_KM;
  } else {
    valor = (15 * VALOR_KM) + ((km - 15) * (0.5 * VALOR_KM));
  }

  if (valor < TAXA_MINIMA) {
    valor = TAXA_MINIMA;
    document.getElementById("aviso").innerText = "âš ï¸ Taxa mÃ­nima aplicada";
  }

  valorFinal = valor.toFixed(2);
  document.getElementById("resultado").innerText =
    `ðŸ’° Valor do frete: R$ ${valorFinal}`;
}

// salvar cliente
function adicionarCliente() {
  const nome = document.getElementById("nomeCliente").value.trim();
  let numero = document.getElementById("numeroCliente").value.replace(/\D/g, "");

  if (!nome || numero.length < 10) {
    alert("Preencha corretamente nome e nÃºmero.");
    return;
  }

  clientes[nome] = "55" + numero;
  localStorage.setItem("clientes", JSON.stringify(clientes));

  carregarClientes();
  alert("Cliente salvo com sucesso!");
}

// enviar WhatsApp
function enviarWhatsApp() {
  const cliente = document.getElementById("cliente").value;
  const km = document.getElementById("km").value;

  if (!cliente || valorFinal === 0) {
    alert("Calcule o frete e selecione a cliente.");
    return;
  }

  const numero = clientes[cliente];
  const data = new Date().toLocaleString("pt-BR");

  const mensagem =
`ðŸï¸ *ALENCAR FRETES*
ðŸ‘¤ Cliente: ${cliente}
ðŸ“ KM: ${km}
ðŸ’° Valor: R$ ${valorFinal}
ðŸ“… ${data}`;

  navigator.clipboard.writeText(mensagem);

  historico.push(mensagem);
  localStorage.setItem("historico", JSON.stringify(historico));
  atualizarHistorico();

  window.open(
    `https://wa.me/${numero}?text=${encodeURIComponent(mensagem)}`,
    "_blank"
  );
}

// histÃ³rico
function atualizarHistorico() {
  const div = document.getElementById("historico");
  div.innerHTML = "";

  historico.slice().reverse().forEach(msg => {
    div.innerHTML += `<p>${msg.replace(/\n/g, "<br>")}<hr></p>`;
  });
}
